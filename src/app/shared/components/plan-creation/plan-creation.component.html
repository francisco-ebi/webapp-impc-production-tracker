<div *ngIf="error && !projectCreation" class="alert alert-danger">{{ error }}</div>
<mat-card>
    <mat-card-title>
        Plan Creation
    </mat-card-title>
    <mat-card-content>
        <ng-container [formGroup]="planCreationForm">
            <table>
                <label *ngIf="planCreation" for="tpo">Project id:</label>
                <div *ngIf="planCreation" id="tpo"><a routerLink="/projects/{{ this.tpn }}">{{ this.tpn }}</a></div>
                <br>
            
                <tr>
                    <td><label for="planType">Plan Type *:</label></td>
                    <td>
                        <mat-form-field appearance="fill">
                            <input matInput *ngIf="!selectType"
                                (blur)="onTouched()" 
                                formControlName="typeName"
                                class="form-control"
                                readonly />
                            <mat-select *ngIf="selectType"
                                (selectionChange)="onPlanTypeSelected($event)"
                                class="form-control"
                                (blur)="onTouched()" 
                                formControlName="typeName"
                            >
                                <mat-option></mat-option>
                                <mat-option *ngFor="let planType of planTypes" [value]="planType.name">
                                    {{ planType.name }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </td>
                </tr>

                <tr>
                    <td><label for="attemtpType">Attempt Type *:</label></td>
                    <td>
                        <mat-form-field appearance="fill">
                            <mat-select id="attemtpType" 
                                    (selectionChange)="onAttemptTypeSelected($event)"
                                    class="form-control"
                                    (blur)="onTouched()" 
                                    formControlName="attemptTypeName"
                            >
                                <mat-option></mat-option>
                                <mat-option *ngFor="let attemptType of filteredAttemptTypesByPlanType" [value]="attemptType.name">
                                    {{ attemptType.name }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </td>
                </tr>

                <!-- Starting Point section. Only available for phenotyping plans -->
                <ng-template id="startingPoint" *ngIf="plan.typeName === 'phenotyping'">
                    <tr>
                        <td><label for="startingPoint">Starting point (Outcome id) *:</label></td>
                        <td>
                            <mat-form-field appearance="fill">
                                <mat-select class="form-control"
                                        (blur)="onTouched()" 
                                        formControlName="startingPoint"
                                >
                                    <mat-option *ngFor="let startingPoint of startingPoints" [value]="startingPoint.tpo">
                                        {{ startingPoint.tpo + ' (' + startingPoint.externalReference + ')' }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </td>
                    </tr>
                </ng-template>

                <tr>
                    <td><label for="workUnit">Work Unit *:</label></td>
                    <td>
                        <mat-form-field appearance="fill">
                            <mat-select (selectionChange)="onWorkUnitChanged($event)" id="workUnit" 
                                    class="form-control"
                                    (blur)="onTouched()" 
                                    formControlName="workUnitName"
                            >
                                <mat-option></mat-option>
                                <mat-option *ngFor="let workUnit of workUnits" [value]="workUnit.name">
                                    {{ workUnit.name }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </td>
                </tr>

                <tr>
                    <td><label for="workGroup">Work Group *:</label></td>
                    <td>
                        <mat-form-field appearance="fill">
                            <mat-select (selectionChange)="onWorkGroupChanged($event)" id="workGroup"
                                    class="form-control"
                                    (blur)="onTouched()" 
                                    formControlName="workGroupName"
                            >
                                <mat-option></mat-option>
                                <mat-option *ngFor="let workGroup of filteredWorkGroupsByWorkUnit" [value]="workGroup.name">
                                    {{ workGroup.name }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </td>
                </tr>

                <tr>
                    <td><label for="workGroup">Funders:</label></td>
                    <td>
                        <mat-form-field appearance="fill">
                            <mat-select multiple id="funderNames"
                                class="form-control"
                                (blur)="onTouched()" 
                                formControlName="funderNames"
                            >
                                <mat-option></mat-option>
                                <mat-option *ngFor="let funder of filteredFundersByWorkGroup" [value]="funder.name">
                                    {{ funder.name }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </td>
                </tr>

                <tr>
                    <td><label for="comment">Comment:</label></td>
                    <td>
                        <mat-form-field appearance="fill" id="comment" >
                            <textarea matInput 
                                (blur)="onTouched()" 
                                formControlName="comment"
                                class="form-control">
                            </textarea>
                        </mat-form-field>
                    </td>
                </tr>


                <mat-card *ngIf="planCreation" class="update-button">
                    <mat-card-content>
                        <button mat-raised-button color="primary" (click)="create()">Create Plan</button>
                        <br>
                        <span style="font-size: 12px; ">* required fields</span>
                        <mat-spinner style="margin:0 auto;" *ngIf="loading" matSuffix mode="indeterminate" diameter=20>
                        </mat-spinner>
                    </mat-card-content>
                </mat-card>

            </table>
        </ng-container>
    </mat-card-content>
</mat-card>