<h3>IMPC Production Numbers</h3>
<div class="container">
  <div>
    <div class="total-genes-wrapper">
      Number of genes with genotype confirmed lines:
      @if (totalNumOfGenes$ | async; as totalNumOfGenes) {
        {{ totalNumOfGenes | number }}
      } @else {
        <ngx-skeleton-loader count="1" [theme]="{'margin-bottom': 0}"></ngx-skeleton-loader>
      }
    </div>
    <p>
      <a href="https://www.gentar.org/tracker-api/api/reports/glt_production_numbers/overlap/intersection" download>
        Genes studied by both ES Cell and CRISPR based techniques
      </a>
    </p>
  </div>
</div>
<div class="chart-container">
  @if (isFetchingData || !charDataIsAvailable ) {
    <div class="loading-overlay">
      @if (isFetchingData) {
        <mat-spinner></mat-spinner>
      }
      @if (!charDataIsAvailable) {
        <h2>There is no data available for the filters selected</h2>
      }
    </div>
  }
  <div class="title-wrapper">
    <h3>Cumulative number of genes studied by ES Cell and CRISPR based techniques</h3>
    @if (chartDirective && chartDirective?.chart; as chart) {
      <div class="legends">
        @for (item of chart.legend.legendItems; track item) {
          <div
            class="legend-item"
            (click)="onLegendItemClick($event, item)"
            >
            <span class="color" [ngStyle]="{ background: item.fillStyle, 'border-color': item.strokeStyle }"></span>
            <span class="text" [ngClass]="{ 'active-filter': isItemFilterActive(item) }">
              {{ item.text }}
            </span>
          </div>
        }
      </div>
    }
  </div>
  <canvas
    baseChart
    class="chart"
    [type]="'line'"
    [data]="chartData"
    [options]="lineChartOptions"
    >
  </canvas>
  <div>
    @if (selectedOption === 'IMPC') {
      <p>Displaying data from the whole IMPC </p>
    }
    @if (selectedOption === 'WorkUnit' && !workUnitControl.value) {
      <p>Please select a work unit</p>
    }
    @if (selectedOption === 'WorkUnit' && workUnitControl.value) {
      <p>Filtering by {{workUnitControl.value}} work unit</p>
    }
    @if (selectedOption === 'MultipleWorkUnit' && !multipleWorkUnitControl.value.length) {
      <p>Please select a work unit</p>
    }
    @if (selectedOption === 'MultipleWorkUnit' && multipleWorkUnitControl.value.length) {
      <p>Filtering by {{multipleWorkUnitControl.value.join(', ')}} work unit</p>
    }
  </div>
</div>
<div class="controls">
  <div class="radio-wrapper">
    <mat-radio-button
      [checked]="selectedOption === 'IMPC'"
      (change)="updateSelection('IMPC')"
      >
      IMPC
    </mat-radio-button>
    <mat-radio-button
      [checked]="selectedOption === 'WorkUnit'"
      (change)="updateSelection('WorkUnit')"
      >
      By work unit
    </mat-radio-button>
    <mat-radio-button
      [checked]="selectedOption === 'MultipleWorkUnit'"
      (change)="updateSelection('MultipleWorkUnit')"
      >
      By multiple work unit
    </mat-radio-button>
  </div>
  <div class="autocomplete-wrapper">
    <div class="inner-wrapper" [class.hidden]="selectedOption !== 'WorkUnit'">
      <mat-form-field>
        <mat-label>Work unit</mat-label>
        <input
          type="text"
          placeholder="Pick one"
          aria-label="Work unit"
          matInput
          #workUnitInput
          [formControl]="workUnitControl"
          [matAutocomplete]="workUnitAutocomplete"
          >
        <mat-autocomplete #workUnitAutocomplete="matAutocomplete">
          @for (unit of workUnits$ | async; track unit) {
            <mat-option [value]="unit">
              {{ unit }}
            </mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>
      <mat-form-field>
        <mat-label>Work group</mat-label>
        <input
          type="text"
          placeholder="Pick one"
          aria-label="Work group"
          matInput
          #workGroupInput
          [formControl]="workGroupControl"
          [matAutocomplete]="workGroupAutocomplete"
          >
        <mat-autocomplete #workGroupAutocomplete="matAutocomplete">
          @for (group of workGroups$ | async; track group) {
            <mat-option [value]="group">
              {{ group }}
            </mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>
    </div>
    <div class="inner-wrapper" [class.hidden]="selectedOption !== 'MultipleWorkUnit'">
      <mat-form-field>
        <mat-label>Work unit</mat-label>
        <mat-select [formControl]="multipleWorkUnitControl" multiple>
          <mat-select-trigger>
            {{multipleWorkUnitControl.value?.[0] || ''}}
            @if ((multipleWorkUnitControl.value?.length || 0) > 1) {
              <span class="example-additional-selection">
                (+{{(multipleWorkUnitControl.value?.length || 0) - 1}} {{multipleWorkUnitControl.value?.length === 2 ? 'other' : 'others'}})
              </span>
            }
          </mat-select-trigger>
          @for (unit of workUnits$ | async; track unit) {
            <mat-option [value]="unit">{{unit}}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
  </div>
  <div class="datepickers-wrapper">
    <mat-form-field>
      <mat-label>Start date</mat-label>
      <input
        matInput
        [matDatepicker]="startDateDP"
        [value]="selectedStartDate"
        (dateChange)="onChangedDate('selectedStartDate', $event)"
        >
      <mat-hint>MM/YYYY</mat-hint>
      <mat-datepicker-toggle matIconSuffix [for]="startDateDP"></mat-datepicker-toggle>
      <mat-datepicker
        #startDateDP
        startView="multi-year"
        (monthSelected)="onSelectedMonth('selectedStartDate', $event, startDateDP)"
        >
      </mat-datepicker>
    </mat-form-field>
    <mat-form-field>
      <mat-label>End date</mat-label>
      <input
        matInput
        [matDatepicker]="endDateDP"
        [value]="selectedEndDate"
        (dateChange)="onChangedDate('selectedEndDate', $event)"
        >
      <mat-hint>MM/YYYY</mat-hint>
      <mat-datepicker-toggle matIconSuffix [for]="endDateDP"></mat-datepicker-toggle>
      <mat-datepicker
        #endDateDP
        startView="multi-year"
        (monthSelected)="onSelectedMonth('selectedEndDate', $event, endDateDP)"
        >
      </mat-datepicker>
    </mat-form-field>
  </div>
  <div class="button-container">
    <button mat-raised-button color="primary" (click)="downloadChart()">
      <mat-icon>file_download</mat-icon>
      Download chart
    </button>
    <button mat-raised-button color="primary" (click)="downloadFile('ES Cell')">
      <mat-icon>file_download</mat-icon>
      Download ES Cell tsv
    </button>
    <button mat-raised-button color="primary" (click)="downloadFile('CRISPR')">
      <mat-icon>file_download</mat-icon>
      Download CRISPR tsv
    </button>
  </div>
</div>
