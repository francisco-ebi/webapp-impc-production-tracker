<mat-card appearance="outlined">
  <mat-card-subtitle>Guides</mat-card-subtitle>
  <mat-card-content>
    @if (canUpdatePlan && crisprAttempt.nucleases !== undefined) {
      <div>
        @if (crisprAttempt.nucleases[0].typeName === 'Cas9') {
          <div id="guidesSearch">
            <div id="guidesSearchForm">
              <form [formGroup]="getGuidesForm">
                <mat-form-field appearance="fill" >
                  <input matInput placeholder="Search by gene symbol" aria-label="State" [matAutocomplete]="auto" [formControl]="searchGene" />
                  <mat-autocomplete #auto="matAutocomplete">
                    @if (isLoading) {
                      <mat-option class="is-loading">Loading...</mat-option>
                    }
                    @if (!isLoading) {
                      @for (gene of filteredGenes; track gene) {
                        <mat-option [value]="gene.symbol" (onSelectionChange)="selectedGene(gene)">
                          <span><b>{{ gene.symbol }}</b> ({{ gene.accId }})</span>
                        </mat-option>
                      }
                    }
                  </mat-autocomplete>
                </mat-form-field>
                @if (error) {
                  <div class="error">{{ error }}</div>
                }
                <button mat-raised-button color="primary" (click)="findGuides();">Find cas9 guides</button>
                @if (isLoadingExons) {
                  <mat-option class="is-loading">Loading...</mat-option>
                }
              </form>
            </div>
            <br/>
            @if (exons) {
              <div>
                <div class="wge mat-elevation-z8">
                  <table mat-table [dataSource]="exons" class="wge_info">
                    <!-- Exon Id Column -->
                    <ng-container matColumnDef="exon_id" sticky>
                      <th mat-header-cell *matHeaderCellDef> Exons </th>
                      <td mat-cell *matCellDef="let element"> {{ element.exonId }} </td>
                    </ng-container>
                    <tr mat-header-row *matHeaderRowDef="displayedExonColumns sticky: true"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedExonColumns; let idx=index;"
                      class="element-row"
                      [style.background-color]="highlightedRows.indexOf(row) !== -1 ? 'orange' : ''"
                    (click)="exonSelected(row, !row.rowClicked); highlightExon(row);"></tr>
                  </table>
                </div>
                @if (guides) {
                  <div class="wge mat-elevation-z8">
                    <table mat-table [dataSource]="guides" class="wge_info">
                      <!-- Sequence Column -->
                      <ng-container matColumnDef="sequence" sticky>
                        <th mat-header-cell *matHeaderCellDef> Sequences </th>
                        <td mat-cell *matCellDef="let element">
                          {{ element.sequence }}
                          @if (element.reversed) {
                            <span style="font-size:8px;vertical-align:sub;">(reversed)</span>
                          }
                        </td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="displayedGuideColumns sticky: true"></tr>
                      <tr mat-row *matRowDef="let row; columns: displayedGuideColumns;"
                        class="element-row"
                        [style.background-color]="row.rowClicked ? 'orange' : ''"
                      (click)="sequenceSelected(row, !row.rowClicked); highlightSequence(row);"></tr>
                    </table>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    }
  </mat-card-content>
  <br/>
  <mat-card-content>
    @if (canUpdatePlan) {
      <div>
        Set individual Concentrations: <input type="checkbox"
        (change)="onSetIndividualConcentrationsClicked($event)"
        [checked]="!isConcentrationTheSameForAllGuides()">
      </div>
    }
    <br/>
    <form [formGroup]="guidesForm">
      @if (canUpdatePlan) {
        <div style="overflow-x:auto;" class="mat-elevation-z8">
          <table>
            <tr>
              <th>GID</th>
              <th>Sequence **</th>
              <th>Guide Sequence **</th>
              <th>PAM</th>
              <th>Chr</th>
              <th>Start *</th>
              <th>Stop *</th>
              <th>Strand</th>
              <th>Genome Build ***</th>
              <th>Format Name</th>
              <th>Source Name</th>
              <th>gRNA Concentration (ng/µl)</th>
            </tr>
            @for (guide of crisprAttempt.guides; track guide; let isFirst = $first) {
              <tr>
                <td>
                  <mat-form-field appearance="fill" style="width:180px;">
                    <input matInput [(ngModel)]="guide.gid" [ngModelOptions]="{standalone: true}"
                      oninput="this.value = this.value.toUpperCase()" disabled>
                  </mat-form-field>
                </td>
                <td style="width: 200px;">
                  <mat-form-field appearance="fill" style="width: 200px;">
                    <textarea matInput [(ngModel)]="guide.sequence" [ngModelOptions]="{standalone: true}"
                    oninput="this.value = this.value.toUpperCase()" trim></textarea>
                  </mat-form-field>
                </td>
                <td>
                  <mat-form-field appearance="fill">
                    <textarea matInput [(ngModel)]="guide.guideSequence" [ngModelOptions]="{standalone: true}"
                    oninput="this.value = this.value.toUpperCase()" trim></textarea>
                  </mat-form-field>
                </td>
                <td>
                  <mat-form-field appearance="fill" class="mediumShort">
                    <input matInput [(ngModel)]="guide.pam" [ngModelOptions]="{standalone: true}"
                      oninput="this.value = this.value.toUpperCase()" trim>
                  </mat-form-field>
                </td>
                <td>
                  <mat-form-field appearance="fill" class="mediumShort">
                    <input matInput [(ngModel)]="guide.chr" [ngModelOptions]="{standalone: true}">
                  </mat-form-field>
                </td>
                <td>
                  <mat-form-field appearance="fill" class="medium">
                    <input matInput [(ngModel)]="guide.start" [ngModelOptions]="{standalone: true}">
                  </mat-form-field>
                </td>
                <td>
                  <mat-form-field appearance="fill" class="medium">
                    <input matInput [(ngModel)]="guide.stop" [ngModelOptions]="{standalone: true}">
                  </mat-form-field>
                </td>
                <td>
                  <mat-form-field appearance="fill" class="mediumShort">
                    <mat-select [(value)]="guide.strand">
                      <mat-option></mat-option>
                      @for (strand of strands; track strand) {
                        <mat-option [value]="strand">
                          {{ strand }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </td>
                <td>
                  <mat-form-field appearance="fill" class="large">
                    <mat-select [(value)]="guide.genomeBuild">
                      <mat-option></mat-option>
                      @for (genomeBuild of genomeBuilds; track genomeBuild) {
                        <mat-option [value]="genomeBuild">
                          {{ genomeBuild }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </td>
                <td>
                  <mat-form-field appearance="fill" class="large">
                    <mat-select [(value)]="guide.formatName">
                      <mat-option></mat-option>
                      @for (format of formatNames; track format) {
                        <mat-option [value]="format.name">
                          {{ format.name }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </td>
                <td>
                  <mat-form-field appearance="fill" class="large">
                    <mat-select [(value)]="guide.sourceName">
                      <mat-option></mat-option>
                      @for (source of sourceNames; track source) {
                        <mat-option [value]="source.name">
                          {{ source.name }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </td>
                @if (sameConcentrationForAll) {
                  @if (isFirst) {
                    <td [attr.rowspan]="this.crisprAttempt.guides.length">
                      <mat-form-field appearance="fill" class="mediumShort">
                        <input matInput formControlName="groupConcentration" (keyup)="onGroupConcentrationChanged()">
                      </mat-form-field>
                    </td>
                  }
                } @else {
                  <td>
                    <div [formGroup]="concentrationForm">
                      <mat-form-field appearance="fill" class="mediumShort">
                        <input matInput (keyup)="onIndividualConcentrationChanged(guide)"
                          [(ngModel)]="guide.grnaConcentration" [ngModelOptions]="{standalone: true}">
                      </mat-form-field>
                    </div>
                  </td>
                }
                @if (canUpdatePlan) {
                  <td>
                    <button class="iconbutton delete-button" mat-icon-button matTooltip="Click to Delete"
                      (click)="deleteRow(guide)">
                      <mat-icon aria-label="Delete">delete</mat-icon>
                    </button>
                  </td>
                }
              </tr>
            }
            @if (canUpdatePlan) {
              <tr>
                <td class="no_border">
                  <button (click)="addRow()" [disabled]="false">
                    <mat-icon aria-hidden="false" aria-label="add icon">add</mat-icon>
                  </button>
                  <span style="font-size: 10px; "> Add guides manually</span>
                  <br>
                  </td>
                </tr>
            }
          </table>
        </div>
        <br>
        <span style="font-size: 12px; ">** Please enter sequence in 5' to 3' orientation</span>
        <br>
        <span style="font-size: 12px; ">*** Guides in GRCm38 will be converted to GRCm39 if possible after saving your changes</span>
      } @else {
        <table class="mat-elevation-z8">
          <tr>
            <th>GID</th>
            <th>Sequence</th>
            <th>Guide Sequence</th>
            <th>PAM</th>
            <th>Coordinates</th>
            <th>Strand</th>
            <th>Genome Build</th>
            <th>Format Name</th>
            <th>Source Name</th>
            <th>gRNA Concentration (ng/µl)</th>
          </tr>
          @for (guide of crisprAttempt.guides; track guide; let isFirst = $first) {
            <tr>
              <td>
                {{ guide.gid }}
              </td>
              <td>
                {{ guide.sequence }}
              </td>
              <td>
                {{ guide.guideSequence }}
              </td>
              <td>
                {{ guide.pam }}
              </td>
              <td>
                {{ guide.chr }}:{{ guide.start || "Not defined" }}-{{ guide.stop || "Not defined" }}
              </td>
              <td>
                {{ guide.strand }}
              </td>
              <td>
                {{ guide.genomeBuild }}
              </td>
              <td>
                {{ guide.formatName }}
              </td>
              <td>
                {{ guide.sourceName }}
              </td>
              @if (sameConcentrationForAll) {
                @if (isFirst) {
                  <td [attr.rowspan]="this.crisprAttempt.guides.length">
                    {{ guide.grnaConcentration ? guide.grnaConcentration || 'ng/µl' : ''}}
                  </td>
                }
              } @else {
                <td>
                  {{ guide.grnaConcentration ? guide.grnaConcentration || 'ng/µl' : ''}}
                </td>
              }
            </tr>
          }
        </table>
      }
    </form>
  </mat-card-content>
</mat-card>
